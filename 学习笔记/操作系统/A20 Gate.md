---
type: note
status: 未发布
created: 2023-04-28 13:02:41
updated: 2023-04-28 13:02:41
tags: []
categories: []
---

## 实模式和保护模式

> 实模式和保护模式都是 CPU 的工作模式，而 CPU 的工作模式是指 CPU 的寻址方式、寄存器大小等用来反应 CPU 在该环境下如何工作的概念。

实模式的“实”体现在进程操作内存时使用的地址就是物理地址，进程可以对整块物理内存中所有的数据进行读写，包括不属于该进程的数据。而在保护模式下进程使用的地址为虚拟地址，需要转化为物理地址后才能真正的操作内存，这使得进程只能访问属于自己的那部分数据，实现了进程之间的数据隔离。

## A20 Gate

`A20 Gate` 本质上是对计算机中第 21 根地址总线（从 0 开始编号为 20，所以叫 `A20 Gate`）的特殊处理，是 `Intel 80286 CPU` 为了兼容前代的 `Intel 8086 CPU`（以下简称 `8086`）做出的妥协。

在 `8086` 中有 20 根地址总线，可以访问的地址是 $2^{20}$ = 1M，与此同时只有 16 根数据总线，能够表示的地址范围仅为 0-64K，为了能够方位到全部的 1M 内存，`8086` 中提供了段地址加偏移地址的地址转换机制（`segment:offset`），`segment` 和 `offset` 都是 16 位的寄存器，最大值是 `0ffffh` 那么真实地址的计算方式为：

<center>``segment`` 左移 4 位 + `offset` = 20 位真实地址</center>

但这种方式引起了新的问题，通过上述模式，能够表示的最大内存为：

FFFFh:FFFFh=FFFF0h+FFFFh=10FFEFh=1M+64K-16Bytes

（1M 多余出来的部分被称做高端内存区 HMA）。但 8086/8088 只有 20 位地址线，如果访问 100000h~10FFEFh 之间的内存，则必须有第 21 根地址线。所以当程序员给出超过 1M（100000H-10FFEFH）的地址时，系统并不认为其访问越界而产生异常，而是自动从重新 0 开始计算，也就是说系统计算实际地址的时候是按照对 1M 求模的方式进行的，这种技术被称为 wrap-around。

到了 80286，系统的地址总线发展为 24 根，这样能够访问的内存可以达到 2^24=16M。Intel 在设计 80286 时提出的目标是，在实模式下，系统所表现的行为应该和 8086/8088 所表现的完全一样，也就是说，在实模式下，80286 以及后续系列，应该和 8086/8088 完全兼容。但最终，80286 芯片却存在一个 BUG：如果程序员访问 100000H-10FFEFH 之间的内存，系统将实际访问这块内存，而不是象过去一样重新从 0 开始。

![](附件/image/A20%20Gate_image_1.png)

为了解决上述问题，IBM 使用键盘控制器上剩余的一些输出线来管理第 21 根地址线（从 0 开始数是第 20 根），被称为 A20 Gate：如果 A20 Gate 被打开，则当程序员给出 100000H-10FFEFH 之间的地址的时候，系统将真正访问这块内存区域；如果 A20 Gate 被禁止，则当程序员给出 100000H-10FFEFH 之间的地址的时候，系统仍然使用 8086/8088 的方式。绝大多数 IBM PC 兼容机默认的 A20 Gate 是被禁止的。由于在当时没有更好的方法来解决这个问题，所以 IBM 使用了键盘控制器来操作 A20 Gate，但这只是一种黑客行为，毕竟 A20 Gate 和键盘操作没有任何关系。在许多新型 PC 上存在着一种通过芯片来直接控制 A20 Gate 的 BIOS 功能。从性能上，这种方法比通过键盘控制器来控制 A20 Gate 要稍微高一点。

上面所述的内存访问模式都是实模式，在 80286 以及更高系列的 PC 中，即使 A20 Gate 被打开，在实模式下所能够访问的内存最大也只能为 10FFEFH，尽管它们的地址总线所能够访问的能力都大大超过这个限制。为了能够访问 10FFEFH 以上的内存，则必须进入保护模式。（其实所谓的实模式，就是 8086/8088 的模式，这种模式存在的唯一理由就是为了让旧的程序能够继续正常的运行在新的 PC 体系上）

从 80286 开始，系统出现了一种新的机制，被称为保护模式。到了 80386，保护模式得到了进一步的完善和发展，并且对于 80386 以后的芯片，保护模式的变化就非常小了。

 ![](附件/image/A20%20Gate_image_2.png)

我们在上一节已经谈到，如果要访问更多的内存，则必须进入保护模式，那么，在保护模式下，A20 Gate 对于内存访问有什么影响呢？

![](附件/image/A20%20Gate_image_3.png)

为了搞清楚这一点，我们先来看一看 A20 的工作原理。A20，从它的名字就可以看出来，其实它就是对于 20-bit（从 0 开始数）的特殊处理 (也就是对第 21 根地址线的处理)。如果 A20 Gate 被禁止，对于 80286 来说，其地址为 24bit，其地址表示为 EFFFFF；对于 80386 极其随后的 32-bit 芯片来说，其地址表示为 FFEFFFFF。这种表示的意思是如果 A20 Gate 被禁止，则其第 20-bit 在 CPU 做地址访问的时候是无效的，永远只能被作为 0；如果 A20 Gate 被打开，则其第 20-bit 是有效的，其值既可以是 0，又可以是 1。

所以，在保护模式下，如果 A20 Gate 被禁止，则可以访问的内存只能是奇数 1M 段，即 1M,3M,5M…，也就是 00000-FFFFF, 200000-2FFFFF,300000-3FFFFF…。如果 A20 Gate 被打开，则可以访问的内存则是连续的。

## 参考资料

- [https://docs.huihoo.com/gnu\_linux/own\_os/booting-a20\_4.htm](https://docs.huihoo.com/gnu_linux/own_os/booting-a20_4.htm)
- [关于X86架构的 Gate A20相关理解\_gatea20激活\_重装起飞的博客-CSDN博客](https://blog.csdn.net/w375073907/article/details/119844052)
- [CPU的实模式和保护模式(一) - 知乎](https://zhuanlan.zhihu.com/p/42309472)
