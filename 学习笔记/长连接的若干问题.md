---
type: blog
status: 未发布
created: 2022-05-23 21:36:42
updated: 2023-05-23 21:36:42
tags: 计算机网络
categories: 
---


## HTTP 中的长连接

在 HTTP 协议中对长短链接的定义如下：

* 长连接：浏览器向服务器进行一次 HTTP 会话访问后，不会直接关闭底层的 TCP 连接，而是会默认保持一段时间，下一次浏览器继续访问同样的服务器时会再次利用到这个连接。
* 短连接：浏览器向服务器每进行一次 HTTP 操作都要建立一个新的连接。

根据两者的定义可以看出，长短连接之间最主要的区别在于是否复用底层的 TCP 连接，如果使用的是短连接，那么就每次访问的服务端的时候都需要重新建立连接，访问完毕后关闭连接；如果使用的是长链接，那么第一次访问服务端的时候会建立连接，后续对服务器的访问都使用的是该链接。

从 HTTP/1.1 起，默认会使用长连接，使用长连接的 HTTP 协议时会在响应头有加入这行代码：

```http
Connection:keep-alive
```

Keep-Alive 不会永久保持连接，它有一个保持时间，可以在不同的服务器软件（如 Apache）中设定这个时间，实现长连接要客户端和服务端都支持长连接。

## TCP 中的长连接

TCP 中实际上没有长连接的概念，因为 TCP 连接只要建立起来就会一直存在，这里所谓的长短本质上是关闭连接的时机不同，如果通信一次后立马关闭连接，那么它就是短连接（HTTP 短连接），如果建立连接后将连接保存一段时间进行复用，那么就是长连接（HTTP 长连接）。

## TCP 如何关闭连接

TCP 关闭连接有如下几个时机：

* 建立连接的双方其中一方主动关闭了连接，或者程序发生崩溃操作系统关闭了连接；
* 如果连接建立之后系统突然断电了，如果这时候有数据在传输，那么数据包会因为无法确认不断的被重复发送，重复一定次数后系统会关闭连接，如果这时候没有数据在传输，那么有以下几种情况：

  * 如果设置了 TCP 的 KeepAlive，那么连接双反会在一定时间没有收到数据时会发送心跳，检测对方是否存活；
  * 如果没有设置 TCP 的 KeepAlive，那么连接将会一直存在。

## TCP 的 KeepAlive 机制

KeepAlive 机制的主要作用是保证连接存活，具体方式是在一定时间没有收到数据的时候就发送心跳包检测连接的另一方是否存活，操作系统中有这么几个参数控制 KeepAlive：

* Keepalive_time：空闲时间，即多长时间连接没有发送数据时开始 KeepAlive 检测，默认情况下是两个小时；
* Keepalive_intvl：发送间隔时间
* Keepalive_probs：最多发送多少个检测数据包。

不过需要注意的是 KeepAlive 并不是 TCP 的标准，所以并不是所有的操作系统都实现了该功能，所以推荐在应用层实现心跳机制。

## 参考资料

1. [HTTP长连接实现原理 - 掘金 (juejin.cn)](https://juejin.cn/post/6923887573861564423)
2. [HTTP长连接和短连接原理浅析-Finclip](https://www.finclip.com/news/f/495.html)
3. [4个实验，彻底搞懂TCP连接的断开_51CTO博客_tcp面向连接](https://blog.51cto.com/u_15067225/4334375)